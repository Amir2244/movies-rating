# Recommendations API

A Spring Boot REST API service that provides movie recommendations generated by the batch training service. This service follows hexagonal architecture principles and integrates with MongoDB to retrieve pre-computed recommendations.

## Architecture

The service follows **Hexagonal Architecture (Ports and Adapters)** with clear separation of concerns:

- **Domain Layer**: Core business models (`UserRecommendations`, `MovieRecommendation`)
- **Application Layer**: Use cases and services (`GetUserRecommendationsUseCase`, `RecommendationsService`)
- **Adapter Layer**: 
  - **Primary Adapters**: REST controllers (`RecommendationsController`)
  - **Secondary Adapters**: MongoDB repositories (`MongoRecommendationsRepositoryAdapter`)

## Features

- Retrieve all recommendations for a user
- Retrieve top N recommendations for a user
- Type-safe domain models using shared-kernel value objects
- Comprehensive error handling and logging
- MongoDB integration with Spring Data
- RESTful API design with proper HTTP status codes

## API Endpoints

### Get User Recommendations

```http
GET /api/v1/recommendations/users/{userId}
```

Retrieves all recommendations for a specific user.

**Parameters:**
- `userId` (path): User ID (positive integer)

**Response:**
```json
{
  "userId": 1,
  "recommendations": [
    {
      "movieId": 100,
      "predictedRating": 4.5,
      "generatedAt": "2024-01-15T10:30:00.000Z"
    },
    {
      "movieId": 200,
      "predictedRating": 4.2,
      "generatedAt": "2024-01-15T10:30:00.000Z"
    }
  ],
  "generatedAt": "2024-01-15T10:30:00.000Z",
  "modelVersion": "ALS-v1.0",
  "totalRecommendations": 2
}
```

### Get Top N User Recommendations

```http
GET /api/v1/recommendations/users/{userId}/top/{limit}
```

Retrieves a limited number of top recommendations for a specific user.

**Parameters:**
- `userId` (path): User ID (positive integer)
- `limit` (path): Maximum number of recommendations (1-100)

**Response:** Same format as above, but limited to the specified number of recommendations.

## Error Responses

### 400 Bad Request
```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "status": 400,
  "error": "Invalid request parameter",
  "message": "User ID must be positive",
  "path": "/api/v1/recommendations/users/-1"
}
```

### 404 Not Found
```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "status": 404,
  "error": "Not Found",
  "message": "No recommendations found for user",
  "path": "/api/v1/recommendations/users/999"
}
```

### 500 Internal Server Error
```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "status": 500,
  "error": "Internal server error",
  "message": "An unexpected error occurred",
  "path": "/api/v1/recommendations/users/1"
}
```

## Configuration

### Application Properties

```properties
# Server Configuration
server.port=8080
server.servlet.context-path=/api/v1

# MongoDB Configuration
spring.data.mongodb.uri=mongodb://localhost:27017/movie_recommendations
spring.data.mongodb.database=movie_recommendations

# Collections Configuration
app.mongodb.recommendations-collection=user_recommendations
app.mongodb.analytics-collection=analytics_data

# Logging Configuration
logging.level.org.hiast=DEBUG
```

### MongoDB Document Structure

The service expects MongoDB documents in the following format (as created by the batch training service):

```json
{
  "_id": "...",
  "userId": 1,
  "recommendations": [
    {
      "movieId": 100,
      "rating": 4.5,
      "generatedAt": "2024-01-15T10:30:00.000Z"
    }
  ],
  "generatedAt": "2024-01-15T10:30:00.000Z",
  "modelVersion": "ALS-v1.0"
}
```

## Running the Service

### Prerequisites

- Java 17+
- Maven 3.6+
- MongoDB 4.4+
- Shared-kernel dependency available

### Build and Run

```bash
# Build the project
mvn clean package

# Run the service
java -jar target/recommendations-api-0.0.1-SNAPSHOT.war

# Or run with Maven
mvn spring-boot:run
```

### Docker Deployment

The service can be deployed using the provided docker-compose.yml in the root project.

## Testing

```bash
# Run unit tests
mvn test

# Run integration tests
mvn verify
```

## Health Check

The service includes Spring Boot Actuator endpoints:

```http
GET /api/v1/actuator/health
GET /api/v1/actuator/info
GET /api/v1/actuator/metrics
```

## Dependencies

- **Spring Boot 3.5.0**: Core framework
- **Spring Data MongoDB**: MongoDB integration
- **Spring Boot Actuator**: Health checks and metrics
- **Shared Kernel**: Domain models and value objects
- **Lombok**: Boilerplate code reduction
- **JUnit 5**: Testing framework
- **Mockito**: Mocking framework

## Development

### Adding New Features

1. Define new use cases in `application.port.in`
2. Implement business logic in `application.service`
3. Add new repository methods in `application.port.out`
4. Implement adapters in `adapter.out.persistence`
5. Create REST endpoints in `adapter.in.web`

### Code Quality

- Follow SOLID principles
- Maintain hexagonal architecture boundaries
- Write comprehensive unit tests
- Use proper logging levels
- Handle exceptions gracefully
