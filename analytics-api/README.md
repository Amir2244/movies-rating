# Analytics API

A comprehensive REST API for querying analytics data generated by the batch processing service, built using hexagonal architecture principles.

## Architecture

The Analytics API follows hexagonal architecture (ports and adapters) pattern:

```
┌─────────────────────────────────────────────────────────────┐
│                    Infrastructure Layer                     │
│  ┌─────────────────┐              ┌─────────────────────┐    │
│  │   REST API      │              │   MongoDB Adapter  │    │
│  │  (Controllers)  │              │   (Persistence)     │    │
│  └─────────────────┘              └─────────────────────┘    │
│           │                                    │             │
└───────────┼────────────────────────────────────┼─────────────┘
            │                                    │
┌───────────┼────────────────────────────────────┼─────────────┐
│           ▼              Application Layer     ▼             │
│  ┌─────────────────┐              ┌─────────────────────┐    │
│  │   Input Ports   │              │   Output Ports      │    │
│  │  (Use Cases)    │              │  (Repository        │    │
│  │                 │              │   Interfaces)       │    │
│  └─────────────────┘              └─────────────────────┘    │
│           │                                    │             │
│           └─────────────────┬──────────────────┘             │
│                            ▼                                │
│                 ┌─────────────────────┐                     │
│                 │  Application        │                     │
│                 │  Services           │                     │
│                 └─────────────────────┘                     │
└─────────────────────────┼───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                     Domain Layer                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │  DataAnalytics  │  │ AnalyticsQuery  │  │ AnalyticsType│  │
│  │   (Entity)      │  │  (Value Object) │  │    (Enum)    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Features

### Core Functionality
- **Query Analytics Data**: Filter analytics by type, date range, and keywords
- **Pagination Support**: Efficient pagination with configurable page sizes
- **Flexible Sorting**: Sort by any field in ascending or descending order
- **Type-Safe Filtering**: Filter by specific analytics types or categories
- **Summary Statistics**: Get comprehensive analytics summaries
- **Individual Record Access**: Retrieve specific analytics by ID

### Analytics Types Supported
- **Data Quality**: `DATA_COMPLETENESS`, `DATA_FRESHNESS`, `DATA_QUALITY`
- **User Behavior**: `USER_ACTIVITY`, `USER_ENGAGEMENT`, `USER_SEGMENTATION`
- **Content Analytics**: `MOVIE_POPULARITY`, `CONTENT_PERFORMANCE`, `RATING_DISTRIBUTION`, `GENRE_DISTRIBUTION`, `TEMPORAL_TRENDS`
- **System Performance**: `PROCESSING_PERFORMANCE`
- **Business Metrics**: `USER_SATISFACTION`

## API Endpoints

### Analytics Data

#### `GET /api/v1/analytics`
Retrieve analytics data with filtering and pagination.

**Query Parameters:**
- `types` (optional): Filter by analytics types (e.g., `USER_ACTIVITY,MOVIE_POPULARITY`)
- `fromDate` (optional): Start date filter (ISO 8601 format: `2024-01-01T00:00:00`)
- `toDate` (optional): End date filter (ISO 8601 format: `2024-12-31T23:59:59`)
- `keyword` (optional): Search keyword in descriptions
- `page` (optional): Page number (default: 0)
- `size` (optional): Page size (default: 20, max: 100)
- `sortBy` (optional): Sort field (default: `generatedAt`)
- `sortDirection` (optional): Sort direction `ASC`/`DESC` (default: `DESC`)

**Example Request:**
```bash
GET /api/v1/analytics?types=USER_ACTIVITY,MOVIE_POPULARITY&page=0&size=10&sortBy=generatedAt&sortDirection=DESC
```

**Response:**
```json
{
  "analytics": [
    {
      "analyticsId": "user_activity_12345",
      "generatedAt": "2024-01-15T10:30:00Z",
      "type": "USER_ACTIVITY",
      "description": "User activity and engagement analytics",
      "metrics": {
        "totalUsers": 15420,
        "activeUsers": 8934,
        "averageRatingsPerUser": 12.5
      }
    }
  ],
  "totalElements": 150,
  "totalPages": 15,
  "currentPage": 0,
  "pageSize": 10,
  "hasNext": true,
  "hasPrevious": false
}
```

#### `GET /api/v1/analytics/{analyticsId}`
Retrieve a specific analytics record by ID.

**Example Request:**
```bash
GET /api/v1/analytics/user_activity_12345
```

#### `GET /api/v1/analytics/types`
Get all available analytics types with their counts.

**Response:**
```json
[
  {
    "type": "USER_ACTIVITY",
    "category": "User Behavior",
    "description": "Tracks user rating patterns and activity levels",
    "count": 45
  }
]
```

#### `GET /api/v1/analytics/summary`
Get analytics summary statistics.

**Response:**
```json
{
  "totalAnalytics": 1250,
  "uniqueTypes": 12,
  "latestAnalyticsDate": "2024-01-15T10:30:00Z",
  "oldestAnalyticsDate": "2024-01-01T00:00:00Z",
  "categorySummaries": [
    {
      "category": "User Behavior",
      "count": 350,
      "percentage": 28.0
    }
  ]
}
```

#### `GET /api/v1/analytics/types/enum`
Get all possible analytics type enums.

#### `GET /api/v1/analytics/health`
Health check endpoint.

## Configuration

### MongoDB Configuration
```properties
# MongoDB Configuration
spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=moviesdb
spring.data.mongodb.auto-index-creation=true

# Analytics Collection Configuration
analytics.mongodb.collection.name=analytics
```

### Server Configuration
```properties
# Server Configuration
server.port=8083
server.servlet.context-path=/
```

## Getting Started

### Prerequisites
- Java 17+
- MongoDB 4.4+
- Maven 3.6+
- Shared Kernel module

### Building and Running

1. **Build the project:**
```bash
mvn clean compile
```

2. **Run the application:**
```bash
mvn spring-boot:run
```

3. **Access the API:**
```
http://localhost:8083/api/v1/analytics
```

### Testing the API

**Get all analytics with pagination:**
```bash
curl "http://localhost:8083/api/v1/analytics?page=0&size=5"
```

**Filter by analytics types:**
```bash
curl "http://localhost:8083/api/v1/analytics?types=USER_ACTIVITY,MOVIE_POPULARITY"
```

**Filter by date range:**
```bash
curl "http://localhost:8083/api/v1/analytics?fromDate=2024-01-01T00:00:00&toDate=2024-01-31T23:59:59"
```

**Search by keyword:**
```bash
curl "http://localhost:8083/api/v1/analytics?keyword=user%20engagement"
```

**Get analytics summary:**
```bash
curl "http://localhost:8083/api/v1/analytics/summary"
```

## Data Model

### DataAnalytics
```java
{
  "analyticsId": "string",          // Unique identifier
  "generatedAt": "instant",         // Generation timestamp
  "type": "AnalyticsType",          // Type of analytics
  "metrics": "Map<String,Object>",  // Key-value metrics
  "description": "string"           // Human-readable description
}
```

### Supported Metrics
Each analytics type contains different metrics. Common examples:
- **User Activity**: `totalUsers`, `activeUsers`, `averageRatingsPerUser`
- **Movie Popularity**: `totalMovies`, `topRatedMovies`, `averageRating`
- **Rating Distribution**: `rating1Count`, `rating2Count`, etc.
- **System Performance**: `processingTime`, `memoryUsage`, `recordsProcessed`

## Error Handling

The API returns consistent error responses:
```json
{
  "code": "INVALID_ARGUMENT",
  "message": "Invalid analytics type: UNKNOWN_TYPE",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

Common error codes:
- `INVALID_ARGUMENT`: Invalid parameter values
- `INVALID_PARAMETER`: Type mismatch in parameters
- `VALIDATION_ERROR`: Request validation failed
- `CONSTRAINT_VIOLATION`: Constraint validation failed
- `INTERNAL_ERROR`: Unexpected server error

## Integration with Batch Processing

The Analytics API is designed to work seamlessly with the batch processing service:

1. **Batch Processing Service** generates analytics and stores them in MongoDB
2. **Analytics API** provides query capabilities over the stored analytics
3. **Shared Kernel** ensures consistent domain models across services

## Performance Considerations

- **Indexing**: MongoDB indexes are automatically created for common query fields
- **Pagination**: All list endpoints support pagination to handle large datasets
- **Caching**: Simple caching is enabled for frequently accessed data
- **Connection Pooling**: MongoDB connection pooling is configured for optimal performance

## Monitoring and Health

- **Health Check**: `GET /api/v1/analytics/health`
- **Actuator Endpoints**: Available at `/actuator/health` and `/actuator/info`
- **Logging**: Structured logging with configurable levels

## Development

### Project Structure
```
src/main/java/org/hiast/analyticsapi/
├── domain/model/              # Domain models
├── application/
│   ├── port/in/              # Input ports (Use Cases)
│   ├── port/out/             # Output ports
│   └── service/              # Application services
├── adapter/
│   ├── in/web/               # REST controllers
│   └── out/persistence/      # MongoDB adapters
└── config/                   # Configuration classes
```

### Adding New Analytics Types

1. Add new enum value to `AnalyticsType`
2. The API will automatically support the new type
3. No additional code changes required due to the flexible architecture

## License

This project is part of the Movies Rating System and follows the same licensing terms. 